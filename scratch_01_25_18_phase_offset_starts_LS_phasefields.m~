homeDirectory = pwd;
recordingList = dir('*201*');

%% get rate/phase maps from all sessions
for rec=1:length(recordingList)
   cd(recordingList(rec).name) 
   sessionInfo = bz_getSessionInfo;
   load([sessionInfo.FileName '.phaseMaps.cellinfo.mat'])
   load([sessionInfo.FileName '.behavior.mat'])
   spikes = bz_GetSpikes;
   
   conditions = length(unique(behavior.events.trialConditions));
   circ_m = nan(length(spikes.times),conditions,200);
   pval = nan(length(spikes.times),conditions,200);
   
   for cell = 1:length(spikes.times)
   for cond=1:conditions
    for j=1:200
        if ~isempty(phaseMaps.phaseMaps{cond}{cell})
        f = find(phaseMaps.phaseMaps{cond}{cell}(:,1)>j-15);
        ff = find(phaseMaps.phaseMaps{cond}{cell}(:,1)<j+15);
        if ~isempty(intersect(f,ff))
        circ_m(cell,cond,j) = circ_mean(phaseMaps.phaseMaps{cond}{cell}(intersect(f,ff),7));
        [pval(cell,cond,j) z] = circ_rtest(phaseMaps.phaseMaps{cond}{cell}(intersect(f,ff),7));
        end
        end
    end
    % check if is field
    
   jumps = find(diff(pval(cell,cond,:)<.01));
   jumps = unique([1 jumps' 201]);
   isField{cell,cond}=[];
   phaseOffset{cell,cond}=[];
   for j=1:length(jumps)-1
       if jumps(j+1) - jumps(j) > 30 & pval(cell,cond,jumps(j)+1) < .01
           if ~isempty(phaseMaps.phaseMaps{cond}{cell})
           isField{cell,cond} = [isField{cell,cond}; jumps(j)];
           f = find(phaseMaps.phaseMaps{cond}{cell}(:,1)>jumps(j)-15);
           ff = find(phaseMaps.phaseMaps{cond}{cell}(:,1)<jumps(j)+15);
           phaseOffset{cell,cond}=  [phaseOffset{cell,cond};circ_mean(phaseMaps.phaseMaps{cond}{cell}(intersect(f,ff),7))];
           end
       end
   end
   end
   end
   
   offsets{rec} = phaseOffset;
   fieldStarts{rec} = isField;
   regions{rec} = phaseMaps.region;
   clear phaseOffset isField pval circ_m jumps 

   cd /home/david/datasets/lsDataset
end


%% now lets plot some ish
reg = [];
off = [];
starts = [];

for rec=1:length(recordingList)
    for cell = 1:size(offsets{rec},1)
        for cond=1:size(offsets{rec},2)
            for fields = 1:length(offsets{rec}{cell,cond})
            off = [off;offsets{rec}{cell,cond}];
            reg = [reg;sum(double(regions{rec}{cell}))];
            starts = [stats; fieldStarts{rec}{cell,cond}];
            end
        end
    end
end






