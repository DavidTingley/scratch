d = dir('bon*')
for i=1:length(d)
    if d(i).isdir
        cd(d(i).name)
            r = dir('*ripplesALL*');
            if ~isempty(r)
                load(r.name)
                stdev = ripples.stdev*2.5;
                
                rippleChan = ripples.rippleChan;
            refChan = ripples.refChan;
            lfp = bz_GetLFP([rippleChan refChan]);

            [b a] = butter(4,[120/(xml.lfpSampleRate./2) 200/(xml.lfpSampleRate./2)],'bandpass');
            for i=1:2
                lfp.filt(:,i) = FiltFiltM(b,a,double(lfp.data(:,i)));
            end

            % need to get intervals of SWS here...

                load([xml.FileName '.SleepState.states.mat'])

                disp(['finding ripples with ch #: ' num2str(rippleChan) ', and noise ch #: ' num2str(refChan)])
                [ripples] = bz_FindRipples(lfp.data(:,1),lfp.timestamps,'noise',...
                    lfp.data(:,2),'durations',[20 300] ,'stdev',stdev,'saveMat',false,'frequency',lfp.samplingRate);
                [ripples.maps,ripples.data,ripples.stats] = bz_RippleStats(lfp.filt(:,1),lfp.timestamps,ripples,'frequency',lfp.samplingRate);

                ripples.rippleChan = rippleChan;
                ripples.refChan = refChan;

                save(['/' animalFolder '/' recording '/' xml.FileName '.ripplesALL.event.mat'],'ripples','-v7.3')

                %% parse by NREM
                ind = [];
                for s = 1:size(SleepState.ints.NREMstate,1)
                    temp = FindInInterval(ripples.peaks,double(SleepState.ints.NREMstate(s,:)));
                    if ~isempty(temp)
                    ind = [ind,temp(1):temp(2)];
                    end
                end
                ripplesNREM.times = ripples.times(ind,:);
                ripplesNREM.peaks = ripples.peaks(ind);
                ripplesNREM.stdev = ripples.stdev;
                ripplesNREM.noise = ripples.noise;
                ripplesNREM.peakNormedPower = ripples.peakNormedPower(ind);
                ripplesNREM.detectorparms = ripples.detectorParams;
                ripplesNREM.detectorName = ripples.detectorName;
                if ~isempty(ripplesNREM.times)
                    [ripplesNREM.maps,ripplesNREM.data,ripplesNREM.stats] = bz_RippleStats(lfp.filt(:,1),lfp.timestamps,ripplesNREM,'frequency',lfp.samplingRate);
                    save(['/' animalFolder '/' recording '/' xml.FileName '.ripplesNREM.event.mat'],'ripplesNREM','-v7.3')
                end
                %% parse by WAKE
                ind = [];
                for s = 1:size(SleepState.ints.WAKEstate,1)
                    temp = FindInInterval(ripples.peaks,double(SleepState.ints.WAKEstate(s,:)));
                    if ~isempty(temp)
                    ind = [ind,temp(1):temp(2)];
                    end
                end
                ripplesWAKE.times = ripples.times(ind,:);
                ripplesWAKE.peaks = ripples.peaks(ind);
                ripplesWAKE.stdev = ripples.stdev;
                ripplesWAKE.noise = ripples.noise;
                ripplesWAKE.peakNormedPower = ripples.peakNormedPower(ind);
                ripplesWAKE.detectorparms = ripples.detectorParams;
                ripplesWAKE.detectorName = ripples.detectorName;
                if ~isempty(ripplesWAKE.times)
                    [ripplesWAKE.maps,ripplesWAKE.data,ripplesWAKE.stats] = bz_RippleStats(lfp.filt(:,1),lfp.timestamps,ripplesWAKE,'frequency',lfp.samplingRate);
                    save(['/' animalFolder '/' recording '/' xml.FileName '.ripplesWAKE.event.mat'],'ripplesWAKE','-v7.3')
                end
            end
                
        cd ..
    end
end
